---
title: æ™ºèƒ½æŒ‡é’ˆ
categories:
  - C++
  - æ™ºèƒ½æŒ‡é’ˆ
tags:
  - auto_ptr
  - unique_ptr
  - shared_ptr
  - weak_ptr
order: 1
---

# æ™ºèƒ½æŒ‡é’ˆ


C++ æ™ºèƒ½æŒ‡é’ˆæ˜¯ç”¨äºè‡ªåŠ¨ç®¡ç†åŠ¨æ€èµ„æºï¼ˆä¸»è¦æ˜¯å †å†…å­˜ï¼‰çš„å¯¹è±¡ï¼Œèƒ½å¤Ÿæœ‰æ•ˆé˜²æ­¢èµ„æºæ³„æ¼å’Œé‡å¤é‡Šæ”¾é—®é¢˜ã€‚
å¸¸è§çš„æ™ºèƒ½æŒ‡é’ˆåŒ…æ‹¬ `auto_ptr`ã€`unique_ptr`ã€`shared_ptr` å’Œ `weak_ptr` ã€‚

---

## ğŸ“Œstd::auto_ptrï¼ˆå·²åºŸå¼ƒï¼‰

### åŸºæœ¬åŸç†

`auto_ptr` é€šè¿‡**ç®¡ç†æƒè½¬ç§»**çš„æ–¹å¼é¿å…èµ„æºé‡å¤é‡Šæ”¾ï¼š
åœ¨æ‹·è´æ—¶å°†èµ„æºçš„æ‰€æœ‰æƒä»ä¸€ä¸ªå¯¹è±¡è½¬ç§»ç»™å¦ä¸€ä¸ªå¯¹è±¡ï¼ŒåŸæ¥çš„å¯¹è±¡æŒ‡é’ˆè¢«ç½®ä¸º `nullptr`ï¼Œ
ç¡®ä¿èµ„æºä»…è¢«é‡Šæ”¾ä¸€æ¬¡ã€‚

å¦‚ä¸‹ä¾‹æ‰€ç¤ºï¼Œ`ap1` çš„æ‰€æœ‰æƒè¢«è½¬ç§»ç»™ `ap2`ï¼Œ`ap1` å˜ä¸º `nullptr`ï¼š

```cpp
int main() 
{
	std::auto_ptr<int> ap1(new int(1));
	std::auto_ptr<int> ap2(ap1);
	*ap2 = 10;
	//*ap1 = 20; // error ï¼Œap1 å·²ç»ä¸º nullptr
	return 0;
}
```

ç„¶è€Œï¼Œè¿™ç§éšå¼çš„èµ„æºè½¬ç§»å®¹æ˜“å¯¼è‡´æ‚¬ç©ºæŒ‡é’ˆæˆ–ç¨‹åºå´©æºƒï¼Œå¾ˆå¤šå…¬å¸å·²ç¦æ­¢ä½¿ç”¨ã€‚
C++11 å `auto_ptr` è¢« `unique_ptr` æ‰€å–ä»£ã€‚

### æ¨¡æ‹Ÿå®ç°

```cpp
namespace ff
{
	template<class T>
	class auto_ptr
	{
	public:
		auto_ptr(T* ptr = nullptr)
			:m_ptr(ptr)
		{}
		~auto_ptr()
		{
			if (m_ptr != nullptr)
			{
				std::cout << "delete: " << m_ptr << std::endl;
				delete m_ptr;
				m_ptr = nullptr;
			}
		}
		auto_ptr(auto_ptr<T>& ap)
			:m_ptr(ap.m_ptr)
		{
			ap.m_ptr = nullptr; 
		}
		auto_ptr<T>& operator=(auto_ptr<T>& ap)
		{
			if (this != &ap)
			{
				delete m_ptr;		
				m_ptr = ap.m_ptr;	
				ap.m_ptr = nullptr;
			}
			return *this;
		}
		T& operator*()
		{
			return *m_ptr;
		}
		T* operator->()
		{
			return &m_ptr;
		}
	private:
		T* m_ptr; 
	};
}
```

## ğŸ“Œstd::unique_ptr

### åŸºæœ¬åŸç†

`unique_ptr` é€šè¿‡ç¦æ­¢æ‹·è´çš„æ–¹å¼ç¡®ä¿èµ„æºçš„å”¯ä¸€æ‹¥æœ‰æƒï¼Œä»è€Œé˜²æ­¢é‡å¤é‡Šæ”¾ã€‚å¦‚ä¸‹ä¾‹ï¼š

```cpp
int main()
{
	std::unique_ptr<int> up1 = std::make_unique<int>(0);
	//std::unique_ptr<int> up2(up1); // ç¼–è¯‘é”™è¯¯
	return 0;
}
```

ä½†é˜²æ‹·è´å…¶å®ä¹Ÿä¸æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„åŠæ³•ï¼Œå› ä¸ºæ€»æœ‰ä¸€äº›åœºæ™¯éœ€è¦è¿›è¡Œæ‹·è´ã€‚
å¦‚æœæƒ³è¦å…±äº«èµ„æºï¼Œå°±éœ€è¦ç”¨åˆ° `shared_ptr` äº†ã€‚

### æ¨¡æ‹Ÿå®ç°

```cpp
namespace ff
{
	template<class T>
	class unique_ptr
	{
	public:
		unique_ptr(T* ptr = nullptr)
			:m_ptr(ptr)
		{}
		~unique_ptr()
		{
			if (m_ptr != nullptr)
			{
				std::cout << "delete: " << m_ptr << std::endl;
				delete m_ptr;
				m_ptr = nullptr;
			}
		}
		T& operator*()
		{
			return *m_ptr;
		}
		T* operator->()
		{
			return &m_ptr;
		}
		// ç¦æ­¢æ‹·è´æ„é€ ä¸èµ‹å€¼
		unique_ptr(unique_ptr<T>& up) = delete;
		unique_ptr<T>& operator=(unique_ptr<T>& up) = delete;
	private:
		T* m_ptr; 
	};
}
```

## ğŸ“Œstd::shared_ptr

### åŸºæœ¬åŸç†

`shared_ptr` é‡‡ç”¨**å¼•ç”¨è®¡æ•°**æœºåˆ¶ç®¡ç†èµ„æºï¼š
- æ¯å—èµ„æºå…³è”ä¸€ä¸ªå¼•ç”¨è®¡æ•°ï¼Œè®°å½•å½“å‰æœ‰å¤šå°‘ä¸ª `shared_ptr` å®ä¾‹å…±äº«è¯¥èµ„æºï¼›
- æ‹·è´æ—¶å¼•ç”¨è®¡æ•° `+1`ï¼Œææ„æˆ–é‡æ–°èµ‹å€¼æ—¶ `-1`ï¼›
- å½“å¼•ç”¨è®¡æ•°é™ä¸º $0$ï¼Œèµ„æºè‡ªåŠ¨é‡Šæ”¾ã€‚

```cpp
int main()
{
	std::shared_ptr<int> sp1 = std::make_shared<int>(1);
	{
		std::shared_ptr<int> sp2(sp1);
		std::cout << sp1.use_count() << std::endl; // è¾“å‡º2
	}
	std::cout << sp1.use_count() << std::endl; // è¾“å‡º1
	return 0;
}
```

### æ¨¡æ‹Ÿå®ç°

```cpp
namespace ff
{
	template<class T>
	class shared_ptr
	{
	public:
		shared_ptr(T* ptr = nullptr)
			: m_ptr(ptr)
			, m_count(new int(1))
		{}
		~shared_ptr()
		{
			if (--(*m_count) == 0)
			{
				if (m_ptr != nullptr)
				{
					std::cout << "delete: " << m_ptr << std::endl;
					delete m_ptr;
					m_ptr = nullptr;
				}
				delete m_count;
				m_count = nullptr;
			}
		}
		shared_ptr(shared_ptr<T>& sp)
			: m_ptr(sp.m_ptr)
			, m_count(sp.m_count)
		{
			(*m_count)++;
		}
		shared_ptr<T>& operator=(shared_ptr<T>& sp)
		{
			if (m_ptr != sp.m_ptr) 
			{
				if (--(*m_count) == 0) 
				{
					if (m_ptr != nullptr)
					{
						std::cout << "delete:" << m_ptr << std::endl;
						delete m_ptr;
						delete m_count;
					}
				}
				m_ptr = sp.m_ptr;		
				m_count = sp.m_count;	
				(*m_count)++;			
			}
			return *this;
		}
		int use_count()
		{
			return *m_count;
		}
		T& operator*()
		{
			return *m_ptr;
		}
		T* operator->()
		{
			return &m_ptr;
		}
	private:
		T* m_ptr;		
		int* m_count;	
	};
}
```

### std::shared_ptrçš„å¾ªç¯å¼•ç”¨é—®é¢˜

åœ¨æŸäº›åœºæ™¯ä¸­ï¼Œå¤šä¸ª `shared_ptr` å¯¹è±¡å¯èƒ½ä¼šç›¸äº’å¼•ç”¨ï¼Œä»è€Œå½¢æˆ**å¾ªç¯å¼•ç”¨**ï¼Œå¯¼è‡´å¼•ç”¨è®¡æ•°æ— æ³•å½’é›¶ï¼Œèµ„æºæ³„éœ²ã€‚

ä¾‹å¦‚åŒå‘é“¾è¡¨èŠ‚ç‚¹ï¼š

```cpp
struct Point
{
	std::shared_ptr<Point> m_prev;
	std::shared_ptr<Point> m_next;
	int m_value;
	Point(int value)
		: m_value(value)
		, m_prev(nullptr)
		, m_next(nullptr)
	{}
	~Point()
	{
		std::cout << "delete: " << m_value << std::endl;
	}
};
int main()
{
	std::shared_ptr<Point> sp1 = std::make_shared<Point>(1);
	std::shared_ptr<Point> sp2 = std::make_shared<Point>(2);
	sp1->m_next = sp2;
	sp2->m_prev = sp1;
	return 0;
}
```

ä¸Šè¿°ä»£ç ä¸­ï¼Œ`sp1` å’Œ `sp2` ç›¸äº’å¼•ç”¨ï¼Œå¯¼è‡´å®ƒä»¬çš„å¼•ç”¨è®¡æ•°å§‹ç»ˆä¸ä¸º $0$ï¼Œç¨‹åºç»“æŸæ—¶èµ„æºä¹Ÿä¸ä¼šè¢«é‡Šæ”¾ã€‚

#### è§£å†³æ–¹æ³•ï¼šä½¿ç”¨ `std::weak_ptr`

`std::weak_ptr` æ˜¯ä¸€ç§ä¸æ‹¥æœ‰èµ„æºçš„æ™ºèƒ½æŒ‡é’ˆï¼Œå¯ä»¥æ‰“ç ´å¾ªç¯å¼•ç”¨é“¾ã€‚
åœ¨è®¾è®¡ç»“æ„ä¸­ï¼Œå»ºè®®å°†ä¸€æ–¹ï¼ˆé€šå¸¸æ˜¯â€œçˆ¶â€æŒ‡é’ˆï¼‰æ”¹ä¸º `weak_ptr`ã€‚

## ğŸ“Œstd::weak_ptr

### åŸºæœ¬åŸç†

`weak_ptr` æ˜¯ä¸ºäº†è§£å†³ `shared_ptr` çš„å¾ªç¯å¼•ç”¨é—®é¢˜è€Œå¼•å…¥çš„è¾…åŠ©æ™ºèƒ½æŒ‡é’ˆï¼Œå®ƒä¸æ‹¥æœ‰èµ„æºçš„æ‰€æœ‰æƒï¼Œä¸ä¼šå½±å“å¼•ç”¨è®¡æ•°ã€‚

é€šè¿‡ `weak_ptr` è§‚å¯Ÿä¸€ä¸ªç”± `shared_ptr` ç®¡ç†çš„å¯¹è±¡ï¼Œå¯ä»¥åœ¨éœ€è¦æ—¶ä¸´æ—¶æå‡ä¸º `shared_ptr` ä½¿ç”¨ï¼Œ
å¦‚æœèµ„æºå·²é‡Šæ”¾ï¼Œæå‡ä¼šå¤±è´¥ï¼Œé¿å…äº†æ‚¬ç©ºæŒ‡é’ˆå’Œèµ„æºæ³„éœ²ã€‚

ä½¿ç”¨ `lock()` æ–¹æ³•å¯ä»¥å°† `weak_ptr` å‡çº§ä¸º `shared_ptr`ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

```cpp
int main()
{
	std::shared_ptr<int> sp = std::make_shared<int>(10);
	std::weak_ptr<int> wp = sp;
	if (auto temp = wp.lock()) // æˆåŠŸæå‡ä¸º std::shared_ptr
	{
		std::cout << *temp << std::endl;
	}
	else
	{
		std::cout << "èµ„æºå·²é‡Šæ”¾ã€‚" << std::endl;
	}
	return 0;
}
```

åœ¨è§£å†³å¾ªç¯å¼•ç”¨æ—¶ï¼Œå¯ä»¥å°†ä¸€æ–¹çš„ `shared_ptr` æ›¿æ¢ä¸º `weak_ptr`ï¼Œ
å¦‚ä¸‹æ”¹å†™åŒå‘é“¾è¡¨çš„ä¾‹å­ï¼š

```cpp
struct Point
{
	std::weak_ptr<Point> m_prev; // å¼±å¼•ç”¨ï¼Œä¸å½±å“å¼•ç”¨è®¡æ•°
	std::shared_ptr<Point> m_next;
	int m_value;
	Point(int value)
		: m_value(value)
		, m_prev{}
		, m_next(nullptr)
	{}
	~Point()
	{
		std::cout << "delete: " << m_value << std::endl;
	}
};
```